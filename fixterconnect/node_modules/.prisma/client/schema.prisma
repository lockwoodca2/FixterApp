// FixterConnect Database Schema
// Using Prisma with Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH MODELS
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String // bcrypt hashed
  type      UserType
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  client     Client?
  contractor Contractor?

  @@map("users")
}

enum UserType {
  CLIENT
  CONTRACTOR
  ADMIN
}

// ============================================
// CLIENT MODEL
// ============================================

model Client {
  id                Int       @id @default(autoincrement())
  userId            Int       @unique @map("user_id")
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  email             String    @unique
  phone             String
  address           String?
  city              String?
  state             String?
  zip               String?
  notificationEmail Boolean   @default(true) @map("notification_email")
  notificationSms   Boolean   @default(true) @map("notification_sms")
  profilePicture    String?   @map("profile_picture")
  isActive          Boolean   @default(true) @map("is_active")
  isBanned          Boolean   @default(false) @map("is_banned")
  suspendedUntil    DateTime? @map("suspended_until")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  reviews         Review[]
  messages        Message[]
  flaggedMessages FlaggedMessage[]
  favorites       FavoriteContractor[]

  @@map("clients")
}

// ============================================
// CONTRACTOR MODEL
// ============================================

model Contractor {
  id                Int       @id @default(autoincrement())
  userId            Int       @unique @map("user_id")
  name              String
  email             String?
  phone             String?
  description       String?   @db.Text
  yearsInBusiness   Int?      @map("years_in_business")
  location          String?
  googleBusinessUrl String?   @map("google_business_url")
  verified          Boolean   @default(false)
  licensed          Boolean   @default(false)
  rating            Float     @default(0)
  reviewCount       Int       @default(0) @map("review_count")
  profilePicture    String?   @map("profile_picture")
  isActive          Boolean   @default(true) @map("is_active")
  isBanned          Boolean   @default(false) @map("is_banned")
  suspendedUntil    DateTime? @map("suspended_until")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  services        ContractorService[]
  bookings        Booking[]
  reviews         Review[]
  messages        Message[]
  availability    Availability[]
  serviceAreas    ContractorServiceArea[]
  flaggedMessages FlaggedMessage[]
  favoritedBy     FavoriteContractor[]
  materials       Material[]

  @@map("contractors")
}

// ============================================
// SERVICES
// ============================================

model Service {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  icon        String
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  contractors ContractorService[]
  bookings    Booking[]

  @@index([isActive])
  @@map("services")
}

model ContractorService {
  id           Int      @id @default(autoincrement())
  contractorId Int      @map("contractor_id")
  serviceId    Int      @map("service_id")
  basePrice    Float?   @map("base_price")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  service    Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([contractorId, serviceId])
  @@map("contractor_services")
}

// ============================================
// BOOKINGS & JOBS
// ============================================

model Booking {
  id                Int           @id @default(autoincrement())
  contractorId      Int           @map("contractor_id")
  clientId          Int           @map("client_id")
  serviceId         Int           @map("service_id")
  serviceAddress    String        @map("service_address")
  scheduledDate     DateTime      @map("scheduled_date")
  scheduledTime     String        @map("scheduled_time")
  estimatedDuration Int?          @map("estimated_duration") // in minutes
  status            BookingStatus @default(PENDING)
  price             Float?
  paymentReceived   Boolean       @default(false) @map("payment_received")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  contractor Contractor     @relation(fields: [contractorId], references: [id])
  client     Client         @relation(fields: [clientId], references: [id])
  service    Service        @relation(fields: [serviceId], references: [id])
  completion JobCompletion?
  photos     JobPhoto[]
  invoice    Invoice?
  payments   Payment[]

  @@index([contractorId])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([contractorId, scheduledDate, status])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model JobCompletion {
  id           Int       @id @default(autoincrement())
  bookingId    Int       @unique @map("booking_id")
  startTime    DateTime? @map("start_time")
  endTime      DateTime? @map("end_time")
  materials    String?   @db.Text
  notes        String?   @db.Text
  audioNoteUrl String?   @map("audio_note_url")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("job_completions")
}

model JobPhoto {
  id           Int       @id @default(autoincrement())
  bookingId    Int       @map("booking_id")
  filename     String
  originalName String    @map("original_name")
  photoType    PhotoType @map("photo_type")
  fileSize     Int       @map("file_size")
  url          String
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("job_photos")
}

enum PhotoType {
  BEFORE
  AFTER
  ADDITIONAL
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id           Int           @id @default(autoincrement())
  contractorId Int           @map("contractor_id")
  clientId     Int           @map("client_id")
  subject      String?
  status       MessageStatus @default(UNREAD)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  contractor   Contractor    @relation(fields: [contractorId], references: [id])
  client       Client        @relation(fields: [clientId], references: [id])
  chatMessages ChatMessage[]

  @@index([contractorId])
  @@index([clientId])
  @@map("messages")
}

enum MessageStatus {
  READ
  UNREAD
}

model ChatMessage {
  id          Int        @id @default(autoincrement())
  messageId   Int        @map("message_id")
  sender      SenderType
  messageText String     @map("message_text") @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("chat_messages")
}

enum SenderType {
  CONTRACTOR
  CLIENT
}

model FlaggedMessage {
  id           Int           @id @default(autoincrement())
  messageId    Int?          @map("message_id")
  messageText  String        @map("message_text") @db.Text
  flaggedBy    FlaggedByType @map("flagged_by")
  flaggedById  Int           @map("flagged_by_id")
  contractorId Int?          @map("contractor_id")
  clientId     Int?          @map("client_id")
  reason       String
  details      String?       @db.Text
  status       FlagStatus    @default(PENDING)
  reviewedBy   Int?          @map("reviewed_by")
  reviewedAt   DateTime?     @map("reviewed_at")
  createdAt    DateTime      @default(now()) @map("created_at")

  // Relations
  contractor Contractor? @relation(fields: [contractorId], references: [id])
  client     Client?     @relation(fields: [clientId], references: [id])

  @@index([status])
  @@map("flagged_messages")
}

enum FlaggedByType {
  CONTRACTOR
  CLIENT
}

enum FlagStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id           Int      @id @default(autoincrement())
  contractorId Int      @map("contractor_id")
  clientId     Int      @map("client_id")
  rating       Int // 1-5 stars
  reviewText   String?  @map("review_text") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id])
  client     Client     @relation(fields: [clientId], references: [id])

  @@index([contractorId])
  @@map("reviews")
}

// ============================================
// PAYMENTS & INVOICES
// ============================================

model Invoice {
  id          Int           @id @default(autoincrement())
  bookingId   Int           @unique @map("booking_id")
  amount      Float
  taxAmount   Float?        @map("tax_amount")
  totalAmount Float         @map("total_amount")
  status      InvoiceStatus @default(PENDING)
  dueDate     DateTime?     @map("due_date")
  paidAt      DateTime?     @map("paid_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  booking  Booking   @relation(fields: [bookingId], references: [id])
  payments Payment[]

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id                  Int           @id @default(autoincrement())
  bookingId           Int           @map("booking_id")
  invoiceId           Int?          @map("invoice_id")
  amount              Float
  paymentMethod       String        @map("payment_method")
  stripePaymentId     String?       @unique @map("stripe_payment_id")
  stripePaymentIntent String?       @unique @map("stripe_payment_intent")
  status              PaymentStatus @default(PENDING)
  paidAt              DateTime?     @map("paid_at")
  createdAt           DateTime      @default(now()) @map("created_at")

  // Relations
  booking Booking  @relation(fields: [bookingId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([bookingId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================
// CONTRACTOR AVAILABILITY
// ============================================

// General working hours for contractors (recurring schedule)
model Availability {
  id           Int       @id @default(autoincrement())
  contractorId Int       @map("contractor_id")
  dayOfWeek    Int?      @map("day_of_week") // 0=Sunday, 1=Monday, etc. NULL for specific dates
  specificDate DateTime? @map("specific_date") // For one-time overrides (vacation, holidays)
  startTime    String    @map("start_time") // e.g., "08:00"
  endTime      String    @map("end_time") // e.g., "17:00"
  maxBookings  Int       @default(8) @map("max_bookings") // Max jobs per day
  isAvailable  Boolean   @default(true) @map("is_available")
  isRecurring  Boolean   @default(true) @map("is_recurring") // true = recurring weekly, false = specific date
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([contractorId, dayOfWeek])
  @@index([contractorId, specificDate])
  @@map("availability")
}

// ============================================
// SERVICE AREAS
// ============================================

// Master list of service areas (managed by admin)
model ServiceArea {
  id        Int      @id @default(autoincrement())
  name      String   @unique // City/area name (e.g., "Boise", "Nampa")
  state     String? // State abbreviation (e.g., "ID", "WA")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("service_areas")
}

// Tracks which areas a contractor serves on which days
model ContractorServiceArea {
  id           Int      @id @default(autoincrement())
  contractorId Int      @map("contractor_id")
  dayOfWeek    Int?     @map("day_of_week") // 0=Sunday, 1=Monday, etc. NULL = all days
  area         String // City/area name (e.g., "Boise", "Nampa")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([contractorId, dayOfWeek])
  @@index([area])
  @@map("contractor_service_areas")
}

// ============================================
// FAVORITE CONTRACTORS
// ============================================

model FavoriteContractor {
  id           Int      @id @default(autoincrement())
  clientId     Int      @map("client_id")
  contractorId Int      @map("contractor_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([clientId, contractorId])
  @@index([clientId])
  @@map("favorite_contractors")
}

// ============================================
// MATERIALS LIBRARY
// ============================================

model Material {
  id           Int      @id @default(autoincrement())
  contractorId Int      @map("contractor_id")
  name         String
  price        Float
  unit         String // e.g., "gallon", "box", "sheet", "tube", "each", "lb", etc.
  description  String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([contractorId])
  @@map("materials")
}

// ============================================
// ADMIN ACTIVITY LOGS
// ============================================

enum ActivitySeverity {
  LOW
  MEDIUM
  HIGH
}

model ActivityLog {
  id        Int              @id @default(autoincrement())
  userId    Int?             @map("user_id") // Admin user who performed the action
  action    String // e.g., "Flag Dismissed", "User Suspended", "User Banned"
  details   String           @db.Text // Full description of what happened
  severity  ActivitySeverity @default(LOW)
  metadata  Json? // Additional structured data (user IDs, flag IDs, etc.)
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([severity])
  @@map("activity_logs")
}
