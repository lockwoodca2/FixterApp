import React, { useState, useEffect } from 'react';
import { useAuth } from '../../context/AuthContext';
import { ApiClient } from '@fixterconnect/core';
import { API_BASE_URL } from '../../config/api';
import {
  Calendar,
  MessageSquare,
  User,
  Star,
  MapPin,
  DollarSign,
  Clock,
  X,
  Mail,
  Phone,
  Home,
  CreditCard,
  Flag,
  AlertTriangle
} from 'react-feather';
import StripePaymentModal from '../payment/StripePaymentModal';

type ActiveSection = 'services' | 'messages' | 'profile' | 'favorites' | 'invoices';
type ServicesTab = 'upcoming' | 'history' | 'quotes';

const ContractorDashboard: React.FC = () => {
  const { logout, user } = useAuth();
  const [activeSection, setActiveSection] = useState<ActiveSection>('services');
  const [servicesTab, setServicesTab] = useState<ServicesTab>('upcoming');
  const [selectedService, setSelectedService] = useState<any>(null);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [selectedInvoice, setSelectedInvoice] = useState<any>(null);
  const [showPaymentModal, setShowPaymentModal] = useState(false);

  // Flag Message state
  const [showFlagModal, setShowFlagModal] = useState(false);
  const [messageToFlag, setMessageToFlag] = useState<any>(null);
  const [flagReason, setFlagReason] = useState('');
  const [flagDetails, setFlagDetails] = useState('');

  // Messages state
  const [showChatModal, setShowChatModal] = useState(false);
  const [selectedConversation, setSelectedConversation] = useState<any>(null);
  const [messageText, setMessageText] = useState('');

  // API client
  const apiClient = new ApiClient(API_BASE_URL);

  // Real data from API
  const [conversations, setConversations] = useState<any[]>([]);
  const [upcomingServices, setUpcomingServices] = useState<any[]>([]);
  const [serviceHistory, setServiceHistory] = useState<any[]>([]);
  const [pendingQuotes, setPendingQuotes] = useState<any[]>([]);
  const [favoriteContractors, setFavoriteContractors] = useState<any[]>([]);
  const [profile, setProfile] = useState<any>(null);
  const [invoices, setInvoices] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // Services and service areas
  const [allServices, setAllServices] = useState<any[]>([]);
  const [contractorServices, setContractorServices] = useState<number[]>([]);
  const [serviceAreas, setServiceAreas] = useState<string[]>([]);
  const [newServiceArea, setNewServiceArea] = useState('');

  // Fetch real data on component mount
  useEffect(() => {
    if (user?.id) {
      fetchContractorData();
    }
  }, [user]);

  // Debug: Track modal state changes
  useEffect(() => {
    console.log('Modal state changed:', {
      showChatModal,
      selectedConversation,
      shouldShow: showChatModal && selectedConversation
    });
  }, [showChatModal, selectedConversation]);

  const fetchContractorData = async () => {
    try {
      setLoading(true);

      // Fetch conversations - contractors receive messages from clients
      const messagesResponse = await fetch(`${API_BASE_URL}/messages/contractor/${user.id}`);
      const messagesData = await messagesResponse.json();

      if (messagesData.success) {
        // Transform messages to match the UI format
        // For contractors, messages come from clients
        const transformedConversations = messagesData.messages.map((msg: any) => ({
          id: msg.id,
          contractorId: msg.client.id, // Using client info instead
          contractorName: `${msg.client.firstName} ${msg.client.lastName}`,
          lastMessage: msg.chatMessages[0]?.messageText || 'No messages yet',
          timestamp: formatTimestamp(msg.updatedAt),
          unread: msg.status === 'UNREAD',
          messages: [] // Will be loaded when conversation is opened
        }));
        setConversations(transformedConversations);
      }

      // Fetch bookings - contractors have their own bookings endpoint
      const bookingsResponse = await fetch(`${API_BASE_URL}/bookings/contractor/${user.id}`);
      const bookingsData = await bookingsResponse.json();

      if (bookingsData.success) {
        // Separate quotes (PENDING with price), upcoming, and history
        const now = new Date();

        // Quotes are PENDING bookings with a price set by contractor
        const quotes = bookingsData.bookings.filter((b: any) =>
          b.status === 'PENDING' && b.price !== null
        ).map(transformBooking);

        // Upcoming are confirmed future bookings (not quotes)
        const upcoming = bookingsData.bookings.filter((b: any) =>
          new Date(b.scheduledDate) >= now &&
          b.status !== 'COMPLETED' &&
          b.status !== 'CANCELLED' &&
          !(b.status === 'PENDING' && b.price !== null) // Exclude quotes
        ).map(transformBooking);

        // History includes completed and past bookings
        const history = bookingsData.bookings.filter((b: any) =>
          new Date(b.scheduledDate) < now ||
          b.status === 'COMPLETED' ||
          b.status === 'CANCELLED'
        ).map(transformBooking);

        setPendingQuotes(quotes);
        setUpcomingServices(upcoming);
        setServiceHistory(history);
      }

      // Skip favorites for contractors (this is a client feature)
      setFavoriteContractors([]);

      // Fetch contractor profile
      const profileResponse = await fetch(`${API_BASE_URL}/contractor/${user.id}`);
      const profileData = await profileResponse.json();

      if (profileData.success) {
        setProfile({
          name: profileData.contractor.name,
          email: profileData.contractor.email || '',
          phone: profileData.contractor.phone || '',
          description: profileData.contractor.description || '',
          yearsInBusiness: profileData.contractor.yearsInBusiness || 0,
          location: profileData.contractor.location || '',
          rating: profileData.contractor.rating || 0,
          reviewCount: profileData.contractor.reviewCount || 0
        });
      }

      // Fetch invoices (contractors may have invoices to send/track)
      const invoicesResponse = await fetch(`${API_BASE_URL}/invoices/contractor/${user.id}`);
      const invoicesData = await invoicesResponse.json();

      if (invoicesData.success) {
        setInvoices(invoicesData.invoices);
      }

      // Fetch all available services
      const servicesResponse = await fetch(`${API_BASE_URL}/services`);
      const servicesData = await servicesResponse.json();
      if (servicesData.success) {
        setAllServices(servicesData.services);
      }

      // Fetch contractor's current services
      if (user?.id) {
        const contractorServicesResponse = await fetch(`${API_BASE_URL}/contractor-services/${user.id}`);
        const contractorServicesData = await contractorServicesResponse.json();
        setContractorServices(contractorServicesData.map((s: any) => s.id));

        // Fetch contractor's service areas
        const areasResponse = await fetch(`${API_BASE_URL}/contractor-areas/${user.id}`);
        const areasData = await areasResponse.json();
        setServiceAreas(areasData);
      }

    } catch (error) {
      console.error('Error fetching contractor data:', error);
    } finally {
      setLoading(false);
    }
  };

  const transformBooking = (booking: any) => ({
    id: booking.id,
    service: booking.service.name,
    provider: `${booking.client.firstName} ${booking.client.lastName}`, // For contractors, the "provider" is actually the client
    providerId: booking.client.id,
    clientName: `${booking.client.firstName} ${booking.client.lastName}`,
    clientPhone: booking.client.phone,
    clientEmail: booking.client.email,
    date: new Date(booking.scheduledDate).toLocaleDateString('en-US', {
      year: 'numeric', month: 'long', day: 'numeric'
    }),
    time: booking.scheduledTime,
    address: booking.serviceAddress,
    price: booking.price || 0,
    status: booking.status,
    rating: 0, // Will be from reviews when implemented
    paymentStatus: booking.paymentReceived ? 'paid' : 'pending'
  });

  const formatTimestamp = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
  };

  const handleAddToFavorites = async (contractorId: number, contractorName: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/favorites`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          clientId: user.id,
          contractorId
        })
      });

      const data = await response.json();

      if (data.success) {
        alert(`Added ${contractorName} to your favorites!`);
        // Refresh favorites list
        const favoritesResponse = await fetch(`${API_BASE_URL}/favorites/client/${user.id}`);
        const favoritesData = await favoritesResponse.json();
        if (favoritesData.success) {
          setFavoriteContractors(favoritesData.favorites);
        }
      } else {
        alert(data.error || 'Failed to add to favorites');
      }
    } catch (error) {
      console.error('Error adding to favorites:', error);
      alert('Failed to add to favorites. Please try again.');
    }
  };

  const handleSaveProfile = async () => {
    if (!profile || !user) return;

    try {
      const response = await fetch(`${API_BASE_URL}/contractor/${user.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: profile.name,
          email: profile.email,
          phone: profile.phone,
          description: profile.description,
          yearsInBusiness: profile.yearsInBusiness,
          location: profile.location
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Profile updated successfully!');
      } else {
        throw new Error(data.error || 'Failed to update profile');
      }
    } catch (error) {
      console.error('Error updating profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  };

  const handleToggleService = (serviceId: number) => {
    setContractorServices(prev =>
      prev.includes(serviceId)
        ? prev.filter(id => id !== serviceId)
        : [...prev, serviceId]
    );
  };

  const handleSaveServices = async () => {
    if (!user) return;

    try {
      const response = await fetch(`${API_BASE_URL}/contractor/services`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contractorId: user.id,
          serviceIds: contractorServices
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Services updated successfully!');
      } else {
        throw new Error(data.error || 'Failed to update services');
      }
    } catch (error) {
      console.error('Error updating services:', error);
      alert('Failed to update services. Please try again.');
    }
  };

  const handleAddServiceArea = () => {
    if (newServiceArea.trim() && !serviceAreas.includes(newServiceArea.trim())) {
      setServiceAreas([...serviceAreas, newServiceArea.trim()]);
      setNewServiceArea('');
    }
  };

  const handleRemoveServiceArea = (area: string) => {
    setServiceAreas(serviceAreas.filter(a => a !== area));
  };

  const handleSaveServiceAreas = async () => {
    if (!user) return;

    try {
      const response = await fetch(`${API_BASE_URL}/contractor/areas`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contractorId: user.id,
          areas: serviceAreas
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Service areas updated successfully!');
      } else {
        throw new Error(data.error || 'Failed to update service areas');
      }
    } catch (error) {
      console.error('Error updating service areas:', error);
      alert('Failed to update service areas. Please try again.');
    }
  };

  const menuItems = [
    { id: 'services' as ActiveSection, label: 'My Jobs & Bookings', icon: Calendar },
    { id: 'invoices' as ActiveSection, label: 'Invoices & Payments', icon: CreditCard },
    { id: 'messages' as ActiveSection, label: 'Client Messages', icon: MessageSquare },
    { id: 'profile' as ActiveSection, label: 'Business Profile', icon: User },
    { id: 'favorites' as ActiveSection, label: 'Favorite Clients', icon: Star }
  ];

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'CONFIRMED':
        return '#10b981';
      case 'PENDING':
        return '#f59e0b';
      case 'COMPLETED':
        return '#3b82f6';
      default:
        return '#94a3b8';
    }
  };

  const renderServiceCard = (service: any, showActions: 'upcoming' | 'history') => (
    <div
      key={service.id}
      style={{
        backgroundColor: 'white',
        borderRadius: '12px',
        padding: '24px',
        marginBottom: '16px',
        border: '1px solid #e2e8f0',
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
      }}
    >
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        marginBottom: '16px'
      }}>
        <h3 style={{
          fontSize: '20px',
          fontWeight: 'bold',
          color: '#1e293b',
          margin: 0
        }}>
          {service.service}
        </h3>
        <div style={{
          padding: '6px 12px',
          backgroundColor: `${getStatusColor(service.status)}15`,
          color: getStatusColor(service.status),
          borderRadius: '6px',
          fontSize: '13px',
          fontWeight: 'bold'
        }}>
          {service.status}
        </div>
      </div>

      <div style={{ display: 'grid', gap: '8px', marginBottom: '20px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b' }}>
          <User size={16} />
          <span style={{ fontSize: '15px' }}>
            <strong style={{ color: '#1e293b' }}>Client:</strong> {service.provider}
          </span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b' }}>
          <Calendar size={16} />
          <span style={{ fontSize: '15px' }}>
            <strong style={{ color: '#1e293b' }}>Date:</strong> {service.date}{service.time ? ` at ${service.time}` : ''}
          </span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b' }}>
          <MapPin size={16} />
          <span style={{ fontSize: '15px' }}>
            <strong style={{ color: '#1e293b' }}>Address:</strong> {service.address}
          </span>
        </div>
        {service.price && (
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b' }}>
            <DollarSign size={16} />
            <span style={{ fontSize: '15px' }}>
              <strong style={{ color: '#1e293b' }}>Price:</strong> ${service.price}
            </span>
          </div>
        )}
      </div>

      <div style={{ display: 'flex', gap: '12px' }}>
        <button
          onClick={() => {
            setSelectedService(service);
            setShowDetailsModal(true);
          }}
          style={{
            padding: '12px 20px',
            backgroundColor: 'white',
            color: '#1e293b',
            border: '2px solid #1e293b',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: 'bold',
            cursor: 'pointer',
            transition: 'all 0.2s'
          }}
        >
          VIEW DETAILS
        </button>
        <button
          onClick={() => handleMessageProvider(service)}
          style={{
            padding: '12px 20px',
            backgroundColor: '#f59e0b',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: 'bold',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}
        >
          <MessageSquare size={16} />
          MESSAGE CLIENT
        </button>
        {showActions === 'upcoming' && (
          <button
            style={{
              padding: '12px 20px',
              backgroundColor: 'white',
              color: '#1e293b',
              border: '2px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: 'bold',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}
          >
            <Calendar size={16} />
            ADD TO CALENDAR
          </button>
        )}
        {showActions === 'history' && (
          <>
            <button
              onClick={() => handleAddToFavorites(service.providerId, service.provider)}
              style={{
                padding: '12px 20px',
                backgroundColor: 'white',
                color: '#1e293b',
                border: '2px solid #e2e8f0',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: 'bold',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}
            >
              <Star size={16} />
              ADD TO FAVORITES
            </button>
            {service.invoice && (
              <button
                style={{
                  padding: '12px 20px',
                  backgroundColor: '#f59e0b',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}
              >
                DOWNLOAD INVOICE
              </button>
            )}
          </>
        )}
      </div>
    </div>
  );

  const renderServicesSection = () => (
    <div>
      <h2 style={{
        fontSize: '28px',
        fontWeight: 'bold',
        color: '#1e293b',
        marginBottom: '24px'
      }}>
        My Jobs & Bookings
      </h2>

      {/* Tab Navigation */}
      <div style={{
        display: 'flex',
        gap: '0',
        marginBottom: '32px',
        borderBottom: '2px solid #e2e8f0'
      }}>
        {[
          { id: 'upcoming' as ServicesTab, label: 'Upcoming' },
          { id: 'history' as ServicesTab, label: 'History' },
          { id: 'quotes' as ServicesTab, label: 'Quote Requests' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setServicesTab(tab.id)}
            style={{
              padding: '12px 24px',
              backgroundColor: 'transparent',
              color: servicesTab === tab.id ? '#3b82f6' : '#64748b',
              border: 'none',
              borderBottom: servicesTab === tab.id ? '3px solid #3b82f6' : '3px solid transparent',
              fontSize: '15px',
              fontWeight: '600',
              cursor: 'pointer',
              marginBottom: '-2px',
              transition: 'all 0.2s'
            }}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* Loading State */}
      {loading && (
        <div style={{
          backgroundColor: 'white',
          borderRadius: '12px',
          padding: '48px',
          textAlign: 'center',
          border: '1px solid #e2e8f0'
        }}>
          <Clock size={48} style={{ color: '#cbd5e1', margin: '0 auto 16px' }} />
          <p style={{ fontSize: '16px', color: '#94a3b8' }}>
            Loading your services...
          </p>
        </div>
      )}

      {/* Tab Content */}
      {!loading && servicesTab === 'upcoming' && (
        <div>
          {upcomingServices.length > 0 ? (
            upcomingServices.map(service => renderServiceCard(service, 'upcoming'))
          ) : (
            <div style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '48px',
              textAlign: 'center',
              border: '1px solid #e2e8f0'
            }}>
              <Calendar size={48} style={{ color: '#cbd5e1', margin: '0 auto 16px' }} />
              <p style={{ fontSize: '16px', color: '#94a3b8' }}>
                No upcoming services scheduled
              </p>
            </div>
          )}
        </div>
      )}

      {!loading && servicesTab === 'history' && (
        <div>
          {serviceHistory.length > 0 ? (
            serviceHistory.map(service => renderServiceCard(service, 'history'))
          ) : (
            <div style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '48px',
              textAlign: 'center',
              border: '1px solid #e2e8f0'
            }}>
              <Calendar size={48} style={{ color: '#cbd5e1', margin: '0 auto 16px' }} />
              <p style={{ fontSize: '16px', color: '#94a3b8' }}>
                No service history yet
              </p>
            </div>
          )}
        </div>
      )}

      {!loading && servicesTab === 'quotes' && (
        <div>
          {pendingQuotes.length > 0 ? (
            pendingQuotes.map(quote => (
              <div
                key={quote.id}
                style={{
                  backgroundColor: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  marginBottom: '16px',
                  border: '2px solid #fbbf24',
                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                  <div>
                    <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1e293b', marginBottom: '8px' }}>
                      {quote.service}
                    </h3>
                    <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '4px' }}>
                      <strong>Contractor:</strong> {quote.contractor}
                    </p>
                    <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '4px' }}>
                      <strong>Scheduled:</strong> {quote.date} at {quote.time}
                    </p>
                    <p style={{ fontSize: '14px', color: '#64748b' }}>
                      <strong>Location:</strong> {quote.location}
                    </p>
                  </div>
                  <div style={{
                    backgroundColor: '#fef3c7',
                    color: '#92400e',
                    padding: '6px 12px',
                    borderRadius: '6px',
                    fontSize: '13px',
                    fontWeight: 'bold'
                  }}>
                    QUOTE RECEIVED
                  </div>
                </div>

                <div style={{
                  backgroundColor: '#f8fafc',
                  padding: '16px',
                  borderRadius: '8px',
                  marginBottom: '16px'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontSize: '14px', color: '#64748b' }}>Quoted Price:</span>
                    <span style={{ fontSize: '24px', fontWeight: 'bold', color: '#10b981' }}>
                      ${quote.price?.toFixed(2) || '0.00'}
                    </span>
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    onClick={() => handleAcceptQuote(quote)}
                    style={{
                      flex: 1,
                      padding: '12px',
                      backgroundColor: '#10b981',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '15px',
                      fontWeight: 'bold',
                      cursor: 'pointer'
                    }}
                  >
                    Accept Quote
                  </button>
                  <button
                    onClick={() => {
                      setSelectedService(quote);
                      setShowDetailsModal(true);
                    }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      backgroundColor: 'white',
                      color: '#64748b',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '15px',
                      fontWeight: 'bold',
                      cursor: 'pointer'
                    }}
                  >
                    View Details
                  </button>
                </div>
              </div>
            ))
          ) : (
            <div style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '48px',
              textAlign: 'center',
              border: '1px solid #e2e8f0'
            }}>
              <Calendar size={48} style={{ color: '#cbd5e1', margin: '0 auto 16px' }} />
              <p style={{ fontSize: '16px', color: '#94a3b8' }}>
                No pending quotes yet
              </p>
            </div>
          )}
        </div>
      )}
    </div>
  );

  const renderFavorites = () => (
    <div>
      <h2 style={{
        fontSize: '28px',
        fontWeight: 'bold',
        color: '#1e293b',
        marginBottom: '8px'
      }}>
        My Favorite Contractors
      </h2>
      <p style={{
        fontSize: '16px',
        color: '#64748b',
        marginBottom: '32px'
      }}>
        Quick access to your preferred service providers
      </p>

      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
        gap: '24px'
      }}>
        {favoriteContractors.map(contractor => (
          <div
            key={contractor.id}
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '24px',
              border: '1px solid #e2e8f0',
              boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
            }}
          >
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '16px',
              marginBottom: '16px'
            }}>
              {/* TODO: Replace with actual profile picture when contractor uploads one */}
              <div style={{
                width: '60px',
                height: '60px',
                borderRadius: '50%',
                backgroundColor: '#f59e0b',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                overflow: 'hidden'
              }}>
                {/* TODO: Uncomment when contractor.profilePicture is available from API */}
                {/* {contractor.profilePicture ? (
                  <img
                    src={contractor.profilePicture}
                    alt={contractor.name}
                    style={{
                      width: '100%',
                      height: '100%',
                      objectFit: 'cover'
                    }}
                  />
                ) : ( */}
                  <User size={32} color="white" />
                {/* )} */}
              </div>
              <div>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: 'bold',
                  color: '#1e293b',
                  margin: 0
                }}>
                  {contractor.name}
                </h3>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px',
                  color: '#f59e0b',
                  marginTop: '4px'
                }}>
                  <Star size={16} fill="#f59e0b" />
                  <span style={{ fontSize: '15px', fontWeight: '600' }}>
                    {contractor.rating}
                  </span>
                </div>
              </div>
            </div>

            <div style={{ marginBottom: '16px' }}>
              <p style={{
                fontSize: '14px',
                fontWeight: '600',
                color: '#1e293b',
                marginBottom: '8px'
              }}>
                Services:
              </p>
              <div style={{
                display: 'flex',
                flexWrap: 'wrap',
                gap: '8px'
              }}>
                {contractor.services.map((service, idx) => (
                  <span
                    key={idx}
                    style={{
                      padding: '6px 12px',
                      backgroundColor: '#f1f5f9',
                      color: '#475569',
                      borderRadius: '6px',
                      fontSize: '13px'
                    }}
                  >
                    {service}
                  </span>
                ))}
              </div>
            </div>

            <div style={{ display: 'flex', gap: '12px' }}>
              <button
                style={{
                  flex: 1,
                  padding: '12px',
                  backgroundColor: '#f59e0b',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}
              >
                REQUEST SERVICE
              </button>
              <button
                style={{
                  flex: 1,
                  padding: '12px',
                  backgroundColor: 'white',
                  color: '#1e293b',
                  border: '2px solid #1e293b',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px'
                }}
              >
                <MessageSquare size={16} />
                MESSAGE
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  const renderProfile = () => {
    if (!profile) {
      return (
        <div style={{
          backgroundColor: 'white',
          borderRadius: '12px',
          padding: '48px',
          textAlign: 'center',
          border: '1px solid #e2e8f0'
        }}>
          <Clock size={48} style={{ color: '#cbd5e1', margin: '0 auto 16px' }} />
          <p style={{ fontSize: '16px', color: '#94a3b8' }}>
            Loading profile...
          </p>
        </div>
      );
    }

    return (
      <div style={{ maxWidth: '800px' }}>
        <h2 style={{
          fontSize: '28px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '32px'
        }}>
          Profile & Preferences
        </h2>

        {/* Business Name */}
        <div style={{ marginBottom: '24px' }}>
          <label style={{
            display: 'block',
            fontSize: '14px',
            fontWeight: '600',
            color: '#64748b',
            marginBottom: '8px'
          }}>
            Business Name
          </label>
          <input
            type="text"
            value={profile.name}
            onChange={(e) => setProfile({ ...profile, name: e.target.value })}
            style={{
              width: '100%',
              padding: '12px',
              border: '2px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '16px'
            }}
          />
        </div>

      {/* Email */}
      <div style={{ marginBottom: '24px' }}>
        <label style={{
          display: 'block',
          fontSize: '14px',
          fontWeight: '600',
          color: '#64748b',
          marginBottom: '8px'
        }}>
          Email Address
        </label>
        <input
          type="email"
          value={profile.email}
          onChange={(e) => setProfile({ ...profile, email: e.target.value })}
          style={{
            width: '100%',
            padding: '12px',
            border: '2px solid #e2e8f0',
            borderRadius: '8px',
            fontSize: '16px'
          }}
        />
      </div>

      {/* Phone */}
      <div style={{ marginBottom: '32px' }}>
        <label style={{
          display: 'block',
          fontSize: '14px',
          fontWeight: '600',
          color: '#64748b',
          marginBottom: '8px'
        }}>
          Phone Number
        </label>
        <input
          type="tel"
          value={profile.phone}
          onChange={(e) => setProfile({ ...profile, phone: e.target.value })}
          style={{
            width: '100%',
            padding: '12px',
            border: '2px solid #e2e8f0',
            borderRadius: '8px',
            fontSize: '16px'
          }}
        />
      </div>

      {/* Business Description */}
      <div style={{ marginBottom: '24px' }}>
        <label style={{
          display: 'block',
          fontSize: '14px',
          fontWeight: '600',
          color: '#64748b',
          marginBottom: '8px'
        }}>
          Business Description
        </label>
        <textarea
          value={profile.description}
          onChange={(e) => setProfile({ ...profile, description: e.target.value })}
          style={{
            width: '100%',
            padding: '12px',
            border: '2px solid #e2e8f0',
            borderRadius: '8px',
            fontSize: '16px',
            minHeight: '120px',
            fontFamily: 'inherit',
            resize: 'vertical'
          }}
          placeholder="Tell clients about your business and services..."
        />
      </div>

      {/* Business Details */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '24px',
        marginBottom: '32px'
      }}>
        <div>
          <label style={{
            display: 'block',
            fontSize: '14px',
            fontWeight: '600',
            color: '#64748b',
            marginBottom: '8px'
          }}>
            Years in Business
          </label>
          <input
            type="number"
            value={profile.yearsInBusiness}
            onChange={(e) => setProfile({ ...profile, yearsInBusiness: parseInt(e.target.value) || 0 })}
            style={{
              width: '100%',
              padding: '12px',
              border: '2px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '16px'
            }}
          />
        </div>
        <div>
          <label style={{
            display: 'block',
            fontSize: '14px',
            fontWeight: '600',
            color: '#64748b',
            marginBottom: '8px'
          }}>
            Service Location/Area
          </label>
          <input
            type="text"
            value={profile.location}
            onChange={(e) => setProfile({ ...profile, location: e.target.value })}
            style={{
              width: '100%',
              padding: '12px',
              border: '2px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '16px'
            }}
            placeholder="e.g., Austin, TX"
          />
        </div>
      </div>

      {/* Rating Display (read-only) */}
      <div style={{
        backgroundColor: '#f8fafc',
        padding: '20px',
        borderRadius: '12px',
        marginBottom: '32px',
        border: '1px solid #e2e8f0'
      }}>
        <h3 style={{
          fontSize: '16px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '12px'
        }}>
          Your Rating
        </h3>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
            color: '#f59e0b'
          }}>
            <Star size={24} fill="#f59e0b" />
            <span style={{ fontSize: '24px', fontWeight: 'bold' }}>
              {profile.rating.toFixed(1)}
            </span>
          </div>
          <span style={{ fontSize: '14px', color: '#64748b' }}>
            ({profile.reviewCount} reviews)
          </span>
        </div>
      </div>

      <button
        onClick={handleSaveProfile}
        style={{
          padding: '14px 32px',
          backgroundColor: '#f59e0b',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '16px',
          fontWeight: 'bold',
          cursor: 'pointer',
          marginBottom: '48px'
        }}
      >
        SAVE CHANGES
      </button>

      {/* Services Offered */}
      <div style={{
        borderTop: '2px solid #e2e8f0',
        paddingTop: '32px',
        marginBottom: '32px'
      }}>
        <h3 style={{
          fontSize: '20px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '8px'
        }}>
          Services Offered
        </h3>
        <p style={{
          fontSize: '14px',
          color: '#64748b',
          marginBottom: '20px'
        }}>
          Select the services you provide to your clients
        </p>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
          gap: '12px',
          marginBottom: '20px'
        }}>
          {allServices.map(service => (
            <label
              key={service.id}
              style={{
                display: 'flex',
                alignItems: 'center',
                padding: '12px',
                backgroundColor: contractorServices.includes(service.id) ? '#eff6ff' : '#f8fafc',
                border: `2px solid ${contractorServices.includes(service.id) ? '#3b82f6' : '#e2e8f0'}`,
                borderRadius: '8px',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
              onMouseEnter={(e) => {
                if (!contractorServices.includes(service.id)) {
                  e.currentTarget.style.borderColor = '#cbd5e1';
                }
              }}
              onMouseLeave={(e) => {
                if (!contractorServices.includes(service.id)) {
                  e.currentTarget.style.borderColor = '#e2e8f0';
                }
              }}
            >
              <input
                type="checkbox"
                checked={contractorServices.includes(service.id)}
                onChange={() => handleToggleService(service.id)}
                style={{
                  width: '18px',
                  height: '18px',
                  marginRight: '10px',
                  cursor: 'pointer'
                }}
              />
              <span style={{
                fontSize: '14px',
                fontWeight: '500',
                color: '#1e293b'
              }}>
                {service.name}
              </span>
            </label>
          ))}
        </div>

        <button
          onClick={handleSaveServices}
          style={{
            padding: '12px 24px',
            backgroundColor: '#3b82f6',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: 'bold',
            cursor: 'pointer'
          }}
        >
          SAVE SERVICES
        </button>
      </div>

      {/* Service Areas */}
      <div style={{
        borderTop: '2px solid #e2e8f0',
        paddingTop: '32px'
      }}>
        <h3 style={{
          fontSize: '20px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '8px'
        }}>
          Service Areas
        </h3>
        <p style={{
          fontSize: '14px',
          color: '#64748b',
          marginBottom: '20px'
        }}>
          Add the cities or zip codes where you provide services
        </p>

        {/* Add New Area Input */}
        <div style={{
          display: 'flex',
          gap: '12px',
          marginBottom: '20px'
        }}>
          <input
            type="text"
            value={newServiceArea}
            onChange={(e) => setNewServiceArea(e.target.value)}
            onKeyPress={(e) => {
              if (e.key === 'Enter') {
                handleAddServiceArea();
              }
            }}
            placeholder="Enter city or zip code (e.g., Austin, TX or 78701)"
            style={{
              flex: 1,
              padding: '12px',
              border: '2px solid #e2e8f0',
              borderRadius: '8px',
              fontSize: '14px'
            }}
          />
          <button
            onClick={handleAddServiceArea}
            style={{
              padding: '12px 24px',
              backgroundColor: '#10b981',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: 'bold',
              cursor: 'pointer',
              whiteSpace: 'nowrap'
            }}
          >
            ADD AREA
          </button>
        </div>

        {/* Current Service Areas */}
        {serviceAreas.length > 0 ? (
          <div style={{
            display: 'flex',
            flexWrap: 'wrap',
            gap: '10px',
            marginBottom: '20px'
          }}>
            {serviceAreas.map((area, index) => (
              <div
                key={index}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '8px 12px',
                  backgroundColor: '#f1f5f9',
                  borderRadius: '6px',
                  border: '1px solid #cbd5e1'
                }}
              >
                <MapPin size={14} color="#64748b" />
                <span style={{ fontSize: '14px', color: '#1e293b' }}>
                  {area}
                </span>
                <button
                  onClick={() => handleRemoveServiceArea(area)}
                  style={{
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    padding: '0',
                    marginLeft: '4px',
                    color: '#ef4444',
                    display: 'flex',
                    alignItems: 'center'
                  }}
                >
                  <X size={16} />
                </button>
              </div>
            ))}
          </div>
        ) : (
          <div style={{
            padding: '24px',
            backgroundColor: '#f8fafc',
            borderRadius: '8px',
            border: '1px solid #e2e8f0',
            textAlign: 'center',
            marginBottom: '20px'
          }}>
            <MapPin size={32} color="#cbd5e1" style={{ margin: '0 auto 8px' }} />
            <p style={{ fontSize: '14px', color: '#94a3b8', margin: 0 }}>
              No service areas added yet
            </p>
          </div>
        )}

        <button
          onClick={handleSaveServiceAreas}
          style={{
            padding: '12px 24px',
            backgroundColor: '#3b82f6',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: 'bold',
            cursor: 'pointer'
          }}
        >
          SAVE SERVICE AREAS
        </button>
      </div>
    </div>
  );
  };

  const handleAcceptQuote = async (quote: any) => {
    if (!quote) return;

    try {
      // Update booking status to CONFIRMED
      const response = await fetch(`${API_BASE_URL}/bookings/${quote.id}/status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: 'CONFIRMED' })
      });

      const data = await response.json();

      if (data.success) {
        alert(`Quote accepted! Booking confirmed with ${quote.clientName} for $${quote.price}.`);

        // Refresh data to update the UI
        await fetchContractorData();
      } else {
        alert('Failed to accept quote. Please try again.');
      }
    } catch (error) {
      console.error('Error accepting quote:', error);
      alert('An error occurred while accepting the quote.');
    }
  };

  const handleFlagMessage = (message: any) => {
    setMessageToFlag(message);
    setShowFlagModal(true);
  };

  const handleSubmitFlag = async () => {
    if (!flagReason) {
      alert('Please select a reason for flagging this message');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/flag-message`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messageId: null, // We could add message ID tracking if needed
          messageText: messageToFlag.text,
          flaggedBy: 'CLIENT',
          flaggedById: user.id,
          contractorId: selectedConversation?.providerId || null,
          clientId: user.id,
          reason: flagReason,
          details: flagDetails || null
        })
      });

      const data = await response.json();

      if (data.success) {
        alert(`Message flagged successfully!\n\nReason: ${flagReason}\n\nAn admin will review this message.`);

        // Reset state
        setShowFlagModal(false);
        setMessageToFlag(null);
        setFlagReason('');
        setFlagDetails('');
      } else {
        throw new Error(data.error || 'Failed to flag message');
      }
    } catch (error) {
      console.error('Error flagging message:', error);
      alert('Failed to flag message. Please try again.');
    }
  };

  const handleMessageProvider = async (service: any) => {
    console.log('handleMessageProvider called with service:', service);
    console.log('Current conversations:', conversations);
    console.log('Current user:', user);

    try {
      // Check if there's already a conversation with this contractor
      const existingConversation = conversations.find(
        conv => conv.contractorId === service.providerId
      );

      console.log('Existing conversation found:', existingConversation);

      if (existingConversation) {
        // Open existing conversation
        console.log('Opening existing conversation');
        await handleOpenChat(existingConversation);
      } else {
        // Create new message thread
        console.log('Creating new message thread');
        const response = await fetch(`${API_BASE_URL}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contractorId: service.providerId,
            clientId: user?.id,
            subject: `Inquiry about ${service.service}`
          })
        });

        const data = await response.json();
        console.log('Create message response:', data);

        if (data.success) {
          // Open the newly created conversation
          const newConversation = {
            id: data.message.id,
            contractorId: service.providerId,
            contractorName: service.provider,
            lastMessage: '',
            timestamp: 'Just now',
            unread: false,
            messages: []
          };

          setConversations([...conversations, newConversation]);
          setSelectedConversation(newConversation);
          setShowChatModal(true);
        } else {
          console.error('Failed to create conversation:', data);
          alert('Failed to start conversation. Please try again.');
        }
      }
    } catch (error) {
      console.error('Error messaging provider:', error);
      alert('An error occurred while trying to message the provider.');
    }
  };

  const handleOpenChat = async (conversation: any) => {
    console.log('handleOpenChat called with conversation:', conversation);
    try {
      // Fetch full conversation with all messages
      console.log('Fetching conversation details from:', `${API_BASE_URL}/messages/${conversation.id}`);
      const response = await fetch(`${API_BASE_URL}/messages/${conversation.id}`);
      console.log('Response status:', response.status);
      const data = await response.json();
      console.log('Response data:', data);

      if (data.success) {
        console.log('Processing messages...');
        // Transform chat messages to match UI format
        const transformedMessages = data.message.chatMessages.map((msg: any) => ({
          sender: msg.sender === 'CLIENT' ? 'client' : 'contractor',
          text: msg.messageText,
          time: new Date(msg.createdAt).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit'
          })
        }));

        console.log('Setting selected conversation and opening modal');
        const newConv = {
          ...conversation,
          messages: transformedMessages
        };
        console.log('New conversation object:', newConv);

        // Use setTimeout to ensure state updates trigger re-render
        setTimeout(() => {
          setSelectedConversation(newConv);
          setShowChatModal(true);
          console.log('Chat modal state updated');
        }, 0);

        // Mark conversation as read
        await fetch(`${API_BASE_URL}/messages/${conversation.id}/read`, {
          method: 'PATCH'
        });

        // Update the conversations list to mark this one as read
        setConversations(conversations.map(conv =>
          conv.id === conversation.id
            ? { ...conv, unread: false }
            : conv
        ));
      } else {
        console.error('API returned success: false', data);
      }
    } catch (error) {
      console.error('Error loading conversation:', error);
    }
  };

  const handleSendMessage = async () => {
    if (!messageText.trim() || !selectedConversation) return;

    try {
      const response = await fetch(`${API_BASE_URL}/messages/${selectedConversation.id}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sender: 'CLIENT',
          messageText: messageText.trim()
        })
      });

      const data = await response.json();

      if (data.success) {
        // Add message to conversation
        const newMessage = {
          sender: 'client',
          text: messageText,
          time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
        };

        setSelectedConversation({
          ...selectedConversation,
          messages: [...selectedConversation.messages, newMessage]
        });
        setMessageText('');
      }
    } catch (error) {
      console.error('Error sending message:', error);
      alert('Failed to send message. Please try again.');
    }
  };

  const renderMessages = () => (
    <div>
      <h2 style={{
        fontSize: '28px',
        fontWeight: 'bold',
        color: '#1e293b',
        marginBottom: '8px'
      }}>
        Messages
      </h2>
      <p style={{
        fontSize: '16px',
        color: '#64748b',
        marginBottom: '32px'
      }}>
        Communicate with your service providers
      </p>

      <div style={{ display: 'grid', gap: '16px' }}>
        {conversations.map((conversation) => (
          <div
            key={conversation.id}
            onClick={() => handleOpenChat(conversation)}
            style={{
              backgroundColor: 'white',
              padding: '20px',
              borderRadius: '12px',
              boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
              border: conversation.unread ? '2px solid #3b82f6' : '1px solid #e2e8f0',
              cursor: 'pointer',
              transition: 'all 0.2s ease'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.15)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            }}
          >
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'flex-start'
            }}>
              <div style={{ flex: 1 }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  marginBottom: '8px'
                }}>
                  <h3 style={{
                    fontSize: '18px',
                    fontWeight: 'bold',
                    color: '#1e293b',
                    margin: 0
                  }}>
                    {conversation.contractorName}
                  </h3>
                  {conversation.unread && (
                    <span style={{
                      width: '10px',
                      height: '10px',
                      backgroundColor: '#3b82f6',
                      borderRadius: '50%'
                    }}></span>
                  )}
                </div>
                <p style={{
                  fontSize: '15px',
                  color: '#64748b',
                  margin: 0
                }}>
                  {conversation.lastMessage}
                </p>
              </div>
              <span style={{
                fontSize: '13px',
                color: '#94a3b8',
                whiteSpace: 'nowrap',
                marginLeft: '16px'
              }}>
                {conversation.timestamp}
              </span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  // Chat Modal
  const renderChatModal = () => {
    if (!(showChatModal && selectedConversation)) return null;
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000
      }}>
        <div style={{
            backgroundColor: 'white',
            borderRadius: '16px',
            width: '90%',
            maxWidth: '600px',
            height: '70vh',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Chat Header */}
            <div style={{
              padding: '20px 24px',
              borderBottom: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h3 style={{
                fontSize: '20px',
                fontWeight: 'bold',
                color: '#1e293b',
                margin: 0
              }}>
                {selectedConversation.contractorName}
              </h3>
              <button
                onClick={() => {
                  setShowChatModal(false);
                  setMessageText('');
                }}
                style={{
                  width: '32px',
                  height: '32px',
                  borderRadius: '50%',
                  border: 'none',
                  backgroundColor: '#f1f5f9',
                  color: '#64748b',
                  fontSize: '18px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                
              </button>
            </div>

            {/* Messages Area */}
            <div style={{
              flex: 1,
              padding: '24px',
              overflowY: 'auto',
              backgroundColor: '#f8fafc'
            }}>
              {selectedConversation.messages.map((message: any, index: number) => (
                <div
                  key={index}
                  style={{
                    display: 'flex',
                    justifyContent: message.sender === 'client' ? 'flex-end' : 'flex-start',
                    marginBottom: '16px',
                    alignItems: 'flex-start',
                    gap: '8px'
                  }}
                >
                  {/* Flag button for contractor messages - appears on LEFT side */}
                  {message.sender !== 'client' && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleFlagMessage({ ...message, conversationId: selectedConversation.id, contractorName: selectedConversation.contractorName });
                      }}
                      style={{
                        padding: '6px',
                        backgroundColor: 'transparent',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s',
                        flexShrink: 0
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#fee2e2';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'transparent';
                      }}
                      title="Flag this message"
                    >
                      <Flag size={16} color="#ef4444" />
                    </button>
                  )}

                  <div style={{
                    maxWidth: '70%',
                    padding: '12px 16px',
                    borderRadius: '12px',
                    backgroundColor: message.sender === 'client' ? '#3b82f6' : 'white',
                    color: message.sender === 'client' ? 'white' : '#1e293b',
                    boxShadow: '0 1px 2px rgba(0,0,0,0.1)'
                  }}>
                    <p style={{
                      fontSize: '15px',
                      margin: '0 0 4px 0',
                      lineHeight: '1.5'
                    }}>
                      {message.text}
                    </p>
                    <span style={{
                      fontSize: '12px',
                      opacity: 0.7
                    }}>
                      {message.time}
                    </span>
                  </div>
                </div>
              ))}
            </div>

            {/* Message Input */}
            <div style={{
              padding: '16px 24px',
              borderTop: '1px solid #e2e8f0',
              display: 'flex',
              gap: '12px'
            }}>
              <input
                type="text"
                value={messageText}
                onChange={(e) => setMessageText(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handleSendMessage();
                  }
                }}
                placeholder="Type your message..."
                style={{
                  flex: 1,
                  padding: '12px 16px',
                  border: '1px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '15px',
                  outline: 'none'
                }}
              />
              <button
                onClick={handleSendMessage}
                disabled={!messageText.trim()}
                style={{
                  padding: '12px 24px',
                  backgroundColor: messageText.trim() ? '#3b82f6' : '#cbd5e1',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: messageText.trim() ? 'pointer' : 'not-allowed'
                }}
              >
                SEND
              </button>
            </div>
          </div>
        </div>
    );
  };

  // Flag Message Modal
  const renderFlagModal = () => {
    if (!(showFlagModal && messageToFlag)) return null;
    return (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.6)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1001
        }}>
          <div style={{
            backgroundColor: 'white',
            borderRadius: '16px',
            padding: '32px',
            maxWidth: '500px',
            width: '90%'
          }}>
            {/* Modal Header */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '24px'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                <AlertTriangle size={24} color="#ef4444" />
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: 'bold',
                  color: '#1e293b',
                  margin: 0
                }}>
                  Flag Message
                </h3>
              </div>
              <button
                onClick={() => {
                  setShowFlagModal(false);
                  setMessageToFlag(null);
                  setFlagReason('');
                  setFlagDetails('');
                }}
                style={{
                  width: '32px',
                  height: '32px',
                  borderRadius: '50%',
                  border: 'none',
                  backgroundColor: '#f1f5f9',
                  color: '#64748b',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                <X size={18} />
              </button>
            </div>

            {/* Message Preview */}
            <div style={{
              padding: '16px',
              backgroundColor: '#f8fafc',
              borderRadius: '8px',
              marginBottom: '24px',
              border: '1px solid #e2e8f0'
            }}>
              <div style={{
                fontSize: '13px',
                color: '#64748b',
                marginBottom: '8px'
              }}>
                Message from {messageToFlag.contractorName}:
              </div>
              <p style={{
                fontSize: '14px',
                color: '#1e293b',
                margin: 0,
                fontStyle: 'italic'
              }}>
                "{messageToFlag.text}"
              </p>
              <div style={{
                fontSize: '12px',
                color: '#94a3b8',
                marginTop: '8px'
              }}>
                {messageToFlag.time}
              </div>
            </div>

            {/* Reason Selection */}
            <div style={{ marginBottom: '20px' }}>
              <label style={{
                display: 'block',
                fontSize: '14px',
                fontWeight: '600',
                color: '#1e293b',
                marginBottom: '8px'
              }}>
                Reason for flagging *
              </label>
              <select
                value={flagReason}
                onChange={(e) => setFlagReason(e.target.value)}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '14px',
                  cursor: 'pointer',
                  outline: 'none'
                }}
              >
                <option value="">Select a reason...</option>
                <option value="Spam">Spam</option>
                <option value="Inappropriate Content">Inappropriate Content</option>
                <option value="Harassment">Harassment</option>
                <option value="Scam/Fraud">Scam/Fraud</option>
                <option value="Offensive Language">Offensive Language</option>
                <option value="Other">Other</option>
              </select>
            </div>

            {/* Additional Details */}
            <div style={{ marginBottom: '24px' }}>
              <label style={{
                display: 'block',
                fontSize: '14px',
                fontWeight: '600',
                color: '#1e293b',
                marginBottom: '8px'
              }}>
                Additional details (optional)
              </label>
              <textarea
                value={flagDetails}
                onChange={(e) => setFlagDetails(e.target.value)}
                placeholder="Please provide any additional context that would help our team review this message..."
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '14px',
                  minHeight: '100px',
                  fontFamily: 'inherit',
                  resize: 'vertical',
                  outline: 'none'
                }}
              />
            </div>

            {/* Warning Notice */}
            <div style={{
              padding: '12px',
              backgroundColor: '#fef3c7',
              borderRadius: '8px',
              marginBottom: '24px',
              display: 'flex',
              gap: '8px'
            }}>
              <AlertTriangle size={16} color="#92400e" style={{ flexShrink: 0, marginTop: '2px' }} />
              <p style={{
                fontSize: '13px',
                color: '#92400e',
                margin: 0,
                lineHeight: '1.5'
              }}>
                This message will be reviewed by our admin team. False reports may result in account restrictions.
              </p>
            </div>

            {/* Action Buttons */}
            <div style={{
              display: 'flex',
              gap: '12px'
            }}>
              <button
                onClick={() => {
                  setShowFlagModal(false);
                  setMessageToFlag(null);
                  setFlagReason('');
                  setFlagDetails('');
                }}
                style={{
                  flex: 1,
                  padding: '12px',
                  backgroundColor: 'white',
                  color: '#64748b',
                  border: '2px solid #e2e8f0',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleSubmitFlag}
                style={{
                  flex: 1,
                  padding: '12px',
                  backgroundColor: '#ef4444',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}
              >
                Flag Message
              </button>
            </div>
          </div>
        </div>
      );
  };

  const renderInvoices = () => {
    const unpaidInvoices = invoices.filter(inv => inv.status === 'unpaid');
    const paidInvoices = invoices.filter(inv => inv.status === 'paid');

    return (
      <div>
        <h2 style={{
          fontSize: '28px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '8px'
        }}>
          Invoices & Payments
        </h2>
        <p style={{
          fontSize: '16px',
          color: '#64748b',
          marginBottom: '32px'
        }}>
          Manage your payments and view invoice history
        </p>

        {/* Unpaid Invoices */}
        {unpaidInvoices.length > 0 && (
          <div style={{ marginBottom: '48px' }}>
            <h3 style={{
              fontSize: '20px',
              fontWeight: 'bold',
              color: '#1e293b',
              marginBottom: '16px'
            }}>
              Unpaid Invoices
            </h3>
            {unpaidInvoices.map(invoice => (
              <div
                key={invoice.id}
                style={{
                  backgroundColor: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  marginBottom: '16px',
                  border: '2px solid #fbbf24',
                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  marginBottom: '16px'
                }}>
                  <div>
                    <h4 style={{
                      fontSize: '18px',
                      fontWeight: 'bold',
                      color: '#1e293b',
                      margin: 0,
                      marginBottom: '4px'
                    }}>
                      {invoice.service}
                    </h4>
                    <p style={{
                      fontSize: '14px',
                      color: '#64748b',
                      margin: 0
                    }}>
                      Invoice #{invoice.invoiceNumber}
                    </p>
                  </div>
                  <div style={{
                    padding: '6px 12px',
                    backgroundColor: '#fef3c7',
                    color: '#92400e',
                    borderRadius: '6px',
                    fontSize: '13px',
                    fontWeight: 'bold'
                  }}>
                    UNPAID
                  </div>
                </div>

                <div style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b', marginBottom: '6px' }}>
                    <User size={16} />
                    <span style={{ fontSize: '15px' }}>
                      <strong style={{ color: '#1e293b' }}>Provider:</strong> {invoice.provider}
                    </span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b', marginBottom: '6px' }}>
                    <Calendar size={16} />
                    <span style={{ fontSize: '15px' }}>
                      <strong style={{ color: '#1e293b' }}>Service Date:</strong> {invoice.date}
                    </span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#64748b', marginBottom: '6px' }}>
                    <Clock size={16} />
                    <span style={{ fontSize: '15px' }}>
                      <strong style={{ color: '#1e293b' }}>Due Date:</strong> {invoice.dueDate}
                    </span>
                  </div>
                  <p style={{
                    fontSize: '15px',
                    color: '#475569',
                    marginTop: '12px',
                    marginBottom: 0
                  }}>
                    {invoice.description}
                  </p>
                </div>

                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  paddingTop: '16px',
                  borderTop: '1px solid #e2e8f0'
                }}>
                  <div>
                    <p style={{
                      fontSize: '14px',
                      color: '#64748b',
                      margin: 0,
                      marginBottom: '4px'
                    }}>
                      Amount Due
                    </p>
                    <p style={{
                      fontSize: '28px',
                      fontWeight: 'bold',
                      color: '#1e293b',
                      margin: 0
                    }}>
                      ${invoice.amount}
                    </p>
                  </div>
                  <button
                    onClick={() => {
                      setSelectedInvoice(invoice);
                      setShowPaymentModal(true);
                    }}
                    style={{
                      padding: '14px 32px',
                      backgroundColor: '#10b981',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '15px',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                      boxShadow: '0 2px 4px rgba(16,185,129,0.2)'
                    }}
                  >
                    PAY NOW
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Paid Invoices */}
        <div>
          <h3 style={{
            fontSize: '20px',
            fontWeight: 'bold',
            color: '#1e293b',
            marginBottom: '16px'
          }}>
            Payment History
          </h3>
          {paidInvoices.length > 0 ? (
            paidInvoices.map(invoice => (
              <div
                key={invoice.id}
                style={{
                  backgroundColor: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  marginBottom: '16px',
                  border: '1px solid #e2e8f0',
                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <div style={{ flex: 1 }}>
                    <h4 style={{
                      fontSize: '18px',
                      fontWeight: 'bold',
                      color: '#1e293b',
                      margin: 0,
                      marginBottom: '4px'
                    }}>
                      {invoice.service}
                    </h4>
                    <p style={{
                      fontSize: '14px',
                      color: '#64748b',
                      margin: 0,
                      marginBottom: '8px'
                    }}>
                      Invoice #{invoice.invoiceNumber}  {invoice.provider}
                    </p>
                    <div style={{ display: 'flex', gap: '16px', fontSize: '14px', color: '#64748b' }}>
                      <span>Service: {invoice.date}</span>
                      <span>Paid: {invoice.paidDate}</span>
                    </div>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
                    <div style={{ textAlign: 'right' }}>
                      <p style={{
                        fontSize: '14px',
                        color: '#64748b',
                        margin: 0,
                        marginBottom: '4px'
                      }}>
                        Amount Paid
                      </p>
                      <p style={{
                        fontSize: '24px',
                        fontWeight: 'bold',
                        color: '#10b981',
                        margin: 0
                      }}>
                        ${invoice.amount}
                      </p>
                    </div>
                    <button
                      onClick={() => {
                        // TODO: Implement download invoice
                        alert(`Download invoice ${invoice.invoiceNumber}`);
                      }}
                      style={{
                        padding: '12px 20px',
                        backgroundColor: 'white',
                        color: '#1e293b',
                        border: '2px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: 'bold',
                        cursor: 'pointer'
                      }}
                    >
                      DOWNLOAD
                    </button>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '48px',
              textAlign: 'center',
              border: '1px solid #e2e8f0'
            }}>
              <CreditCard size={48} style={{ color: '#cbd5e1', marginBottom: '16px' }} />
              <p style={{ fontSize: '16px', color: '#94a3b8' }}>
                No payment history yet
              </p>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderContent = () => {
    switch (activeSection) {
      case 'services':
        return renderServicesSection();
      case 'invoices':
        return renderInvoices();
      case 'favorites':
        return renderFavorites();
      case 'profile':
        return renderProfile();
      case 'messages':
        return renderMessages();
      default:
        return renderServicesSection();
    }
  };

  return (
    <div style={{
      display: 'flex',
      minHeight: '100vh',
      backgroundColor: '#f8fafc'
    }}>
      {/* Sidebar */}
      <div style={{
        width: '280px',
        backgroundColor: 'white',
        borderRight: '1px solid #e2e8f0',
        padding: '24px',
        display: 'flex',
        flexDirection: 'column'
      }}>
        {/* Logo/Title */}
        <h1 style={{
          fontSize: '24px',
          fontWeight: 'bold',
          color: '#1e293b',
          marginBottom: '32px'
        }}>
          Contractor Dashboard
        </h1>

        {/* Menu Items */}
        <nav style={{ flex: 1 }}>
          {menuItems.map((item) => {
            const Icon = item.icon;
            const isActive = activeSection === item.id;

            return (
              <button
                key={item.id}
                onClick={() => setActiveSection(item.id)}
                style={{
                  width: '100%',
                  padding: '14px 16px',
                  marginBottom: '8px',
                  backgroundColor: isActive ? '#6366f1' : 'transparent',
                  color: isActive ? 'white' : '#64748b',
                  border: 'none',
                  borderRadius: '10px',
                  fontSize: '15px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  transition: 'all 0.2s',
                  textAlign: 'left'
                }}
                onMouseEnter={(e) => {
                  if (!isActive) {
                    e.currentTarget.style.backgroundColor = '#f1f5f9';
                  }
                }}
                onMouseLeave={(e) => {
                  if (!isActive) {
                    e.currentTarget.style.backgroundColor = 'transparent';
                  }
                }}
              >
                <Icon size={18} />
                {item.label}
              </button>
            );
          })}
        </nav>

        {/* Back to Home */}
        <button
          onClick={() => window.location.href = '/'}
          style={{
            width: '100%',
            padding: '12px',
            backgroundColor: 'transparent',
            color: '#64748b',
            border: '1px solid #e2e8f0',
            borderRadius: '8px',
            fontSize: '14px',
            fontWeight: '600',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '8px'
          }}
        >
           Back to Home
        </button>
      </div>

      {/* Main Content */}
      <div style={{
        flex: 1,
        padding: '40px',
        overflowY: 'auto'
      }}>
        {renderContent()}
      </div>

      {/* Service Details Modal */}
      {showDetailsModal && selectedService && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: 'white',
            borderRadius: '16px',
            padding: '32px',
            maxWidth: '600px',
            width: '90%',
            maxHeight: '80vh',
            overflowY: 'auto',
            position: 'relative'
          }}>
            <button
              onClick={() => setShowDetailsModal(false)}
              style={{
                position: 'absolute',
                top: '24px',
                right: '24px',
                background: 'none',
                border: 'none',
                cursor: 'pointer',
                color: '#64748b',
                padding: '4px'
              }}
            >
              <X size={24} />
            </button>

            <h2 style={{
              fontSize: '24px',
              fontWeight: 'bold',
              color: '#1e293b',
              marginBottom: '8px'
            }}>
              {selectedService.service}
            </h2>
            <p style={{
              fontSize: '16px',
              color: '#64748b',
              marginBottom: '24px'
            }}>
              {selectedService.provider} - {selectedService.date}
            </p>

            <div style={{ marginBottom: '24px' }}>
              {selectedService.status && (
                <div style={{ marginBottom: '12px' }}>
                  <span style={{ fontWeight: 'bold', color: '#1e293b' }}>Status: </span>
                  <span style={{
                    padding: '4px 12px',
                    backgroundColor: `${getStatusColor(selectedService.status)}15`,
                    color: getStatusColor(selectedService.status),
                    borderRadius: '6px',
                    fontSize: '13px',
                    fontWeight: 'bold'
                  }}>
                    {selectedService.status}
                  </span>
                </div>
              )}
              {selectedService.time && (
                <p style={{ marginBottom: '8px' }}>
                  <span style={{ fontWeight: 'bold', color: '#1e293b' }}>Date & Time: </span>
                  {selectedService.date} at {selectedService.time}
                </p>
              )}
              <p style={{ marginBottom: '8px' }}>
                <span style={{ fontWeight: 'bold', color: '#1e293b' }}>Address: </span>
                {selectedService.address}
              </p>
              {selectedService.price && (
                <p style={{ marginBottom: '8px' }}>
                  <span style={{ fontWeight: 'bold', color: '#1e293b' }}>Price: </span>
                  ${selectedService.price}
                </p>
              )}
            </div>

            {selectedService.notes && (
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{
                  fontSize: '16px',
                  fontWeight: 'bold',
                  color: '#1e293b',
                  marginBottom: '8px'
                }}>
                  Notes
                </h4>
                <p style={{ color: '#64748b', fontSize: '15px' }}>
                  {selectedService.notes}
                </p>
              </div>
            )}

            {selectedService.workPerformed && (
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{
                  fontSize: '16px',
                  fontWeight: 'bold',
                  color: '#1e293b',
                  marginBottom: '8px'
                }}>
                  Work Performed
                </h4>
                <p style={{ color: '#64748b', fontSize: '15px' }}>
                  {selectedService.workPerformed}
                </p>
              </div>
            )}

            {selectedService.status === 'COMPLETED' && (
              <>
                {(selectedService.beforePhotos || selectedService.afterPhotos) && (
                  <div style={{ marginBottom: '24px' }}>
                    <h4 style={{
                      fontSize: '16px',
                      fontWeight: 'bold',
                      color: '#1e293b',
                      marginBottom: '12px'
                    }}>
                      Service Photos
                    </h4>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                      <div>
                        <p style={{ fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>
                          Before:
                        </p>
                        <div style={{
                          padding: '32px',
                          backgroundColor: '#f8fafc',
                          borderRadius: '8px',
                          textAlign: 'center',
                          color: '#94a3b8',
                          fontSize: '14px'
                        }}>
                          Photo placeholder
                        </div>
                      </div>
                      <div>
                        <p style={{ fontWeight: '600', color: '#64748b', marginBottom: '8px' }}>
                          After:
                        </p>
                        <div style={{
                          padding: '32px',
                          backgroundColor: '#f8fafc',
                          borderRadius: '8px',
                          textAlign: 'center',
                          color: '#94a3b8',
                          fontSize: '14px'
                        }}>
                          Photo placeholder
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                <div style={{
                  display: 'flex',
                  gap: '12px',
                  justifyContent: 'flex-end'
                }}>
                  <button
                    onClick={() => handleAddToFavorites(selectedService.providerId, selectedService.provider)}
                    style={{
                      padding: '12px 24px',
                      backgroundColor: 'white',
                      color: '#1e293b',
                      border: '2px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}
                  >
                    <Star size={16} />
                    ADD TO FAVORITES
                  </button>
                  {selectedService.invoice && (
                    <button
                      style={{
                        padding: '12px 24px',
                        backgroundColor: '#f59e0b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: 'bold',
                        cursor: 'pointer'
                      }}
                    >
                      DOWNLOAD INVOICE
                    </button>
                  )}
                  <button
                    style={{
                      padding: '12px 24px',
                      backgroundColor: 'white',
                      color: '#1e293b',
                      border: '2px solid #1e293b',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: 'bold',
                      cursor: 'pointer'
                    }}
                  >
                    LEAVE GOOGLE REVIEW
                  </button>
                </div>
              </>
            )}

            {selectedService.status !== 'COMPLETED' && (
              <div style={{
                display: 'flex',
                gap: '12px',
                justifyContent: 'flex-end'
              }}>
                <button
                  style={{
                    padding: '12px 24px',
                    backgroundColor: 'white',
                    color: '#1e293b',
                    border: '2px solid #1e293b',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    cursor: 'pointer'
                  }}
                >
                  RESCHEDULE
                </button>
                <button
                  style={{
                    padding: '12px 24px',
                    backgroundColor: 'white',
                    color: '#ef4444',
                    border: '2px solid #ef4444',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    cursor: 'pointer'
                  }}
                >
                  CANCEL SERVICE
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Stripe Payment Modal */}
      <StripePaymentModal
        invoice={selectedInvoice}
        onClose={() => {
          setShowPaymentModal(false);
          setSelectedInvoice(null);
        }}
        onSuccess={() => {
          // TODO: Refresh invoices from API after successful payment
          console.log('Payment successful!');
        }}
      />
    </div>
  );
};

export default ContractorDashboard;
